<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AdultChat – Model Konsole</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #050509;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 0.75rem 1rem;
      background: linear-gradient(90deg, #7b0022, #2b0010);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }
    .role-pill {
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
    }
    main {
      display: flex;
      height: calc(100vh - 60px);
    }
    .sidebar {
      width: 260px;
      background: #0b0b12;
      border-right: 1px solid rgba(255,255,255,0.12);
      padding: 0.75rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
      box-sizing: border-box;
    }
    .card {
      background: #11111a;
      border-radius: 12px;
      padding: 0.75rem;
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.2rem;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 0.3rem 0.45rem;
      border-radius: 6px;
      border: 1px solid #444;
      background: #181820;
      color: #f5f5f5;
      margin-bottom: 0.4rem;
    }
    button {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: none;
      background: #7b0022;
      color: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }
    button:hover {
      background: #a10030;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .small {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .convo-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 50vh;
      overflow: auto;
    }
    .convo-item {
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .convo-item:hover {
      background: rgba(255,255,255,0.06);
    }
    .convo-item.active {
      background: rgba(123,0,34,0.45);
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
    }
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .chat-messages {
      flex: 1;
      min-height: 0;
      max-height: calc(100vh - 230px);
      overflow: auto;
      padding-right: 0.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .msg {
      max-width: 75%;
      padding: 0.35rem 0.55rem;
      border-radius: 10px;
      font-size: 0.82rem;
      line-height: 1.3;
    }
    .msg.me {
      align-self: flex-end;
      background: #7b0022;
    }
    .msg.other {
      align-self: flex-start;
      background: #181824;
    }
    .msg-meta {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.1rem;
    }
    .chat-input-row {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .chat-input-row input {
      margin-bottom: 0;
    }
    .error {
      color: #ff8080;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    .ok {
      color: #9eff9e;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>AdultChat – Model Konsole</h1>
    <div id="header-info">
      <span class="small">Nicht eingeloggt</span>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="card" id="login-card">
        <h2 style="font-size:1rem;margin-top:0;">Login als Model</h2>
        <label for="login-email">E-Mail</label>
        <input id="login-email" type="email" placeholder="model@test.com" />
        <label for="login-password">Passwort</label>
        <input id="login-password" type="password" placeholder="Passwort" />
        <button id="btn-login-model">Login</button>
        <div id="login-status" class="small" style="margin-top:0.4rem;opacity:0.8;">
          Tipp: Benutze einen Model-Account aus api-test.html
        </div>
      </div>

      <div class="card" id="model-info-card" style="display:none;">
        <h2 style="font-size:1rem;margin-top:0;">Dein Account</h2>
        <div class="small" id="model-email"></div>
        <div class="small" id="model-id"></div>
        <div class="small" id="model-role"></div>
        <div class="small" id="model-tokens"></div>
        <button id="btn-load-convos" style="margin-top:0.5rem;">Konversationen laden</button>
        <div class="small" style="margin-top:0.3rem;">Links siehst du alle Clients, die dir geschrieben haben.</div>
      </div>

      <div class="card" id="convo-list-card" style="display:none;">
        <h2 style="font-size:1rem;margin-top:0;">Konversationen</h2>
        <ul class="convo-list" id="convo-list"></ul>
      </div>
    </aside>

    <section class="content">
      <div class="card chat-window">
        <div class="chat-header">
          <div>
            <div class="small">Aktueller Chat mit</div>
            <div id="chat-partner-label" style="font-weight:600;">–</div>
          </div>
          <div class="small" id="chat-info-label">Bitte zuerst einloggen und Konversation wählen.</div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- Nachrichten erscheinen hier -->
        </div>
        <div class="chat-input-row">
          <input
            id="chat-input"
            type="text"
            placeholder="Antwort als Model schreiben..."
          />
          <button id="btn-send-reply">Senden</button>
        </div>
        <div id="chat-status" class="small"></div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "http://localhost:4000";

    let currentModelUser = null;
    let allUsers = [];
    let currentPartnerId = null;
    let currentMessages = [];

    const headerInfo = document.getElementById("header-info");

    const loginCard = document.getElementById("login-card");
    const modelInfoCard = document.getElementById("model-info-card");
    const convoListCard = document.getElementById("convo-list-card");

    const loginEmailInput = document.getElementById("login-email");
    const loginPasswordInput = document.getElementById("login-password");
    const btnLoginModel = document.getElementById("btn-login-model");
    const loginStatus = document.getElementById("login-status");

    const modelEmail = document.getElementById("model-email");
    const modelId = document.getElementById("model-id");
    const modelRole = document.getElementById("model-role");
    const modelTokens = document.getElementById("model-tokens");
    const btnLoadConvos = document.getElementById("btn-load-convos");
    const convoListEl = document.getElementById("convo-list");

    const chatPartnerLabel = document.getElementById("chat-partner-label");
    const chatInfoLabel = document.getElementById("chat-info-label");
    const chatMessagesEl = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const btnSendReply = document.getElementById("btn-send-reply");
    const chatStatus = document.getElementById("chat-status");

    function setHeaderLoggedOut() {
      headerInfo.innerHTML = '<span class="small">Nicht eingeloggt</span>';
    }

    function setHeaderLoggedIn(user) {
      headerInfo.innerHTML =
        '<span class="role-pill">Model</span> ' +
        '<span class="small" style="margin-left:0.5rem;">' +
        user.email +
        ' (ID: ' +
        user.id +
        ")</span>";
    }

    function setLoginStatus(msg, ok = false) {
      if (!loginStatus) return;
      loginStatus.textContent = msg;
      loginStatus.className = ok ? "small ok" : "small error";
    }

    function setChatStatus(msg, ok = false) {
      if (!chatStatus) return;
      chatStatus.textContent = msg;
      chatStatus.className = ok ? "small ok" : "small error";
    }

    async function loadAllUsers() {
      try {
        const res = await fetch(API_BASE + "/api/users");
        const data = await res.json();
        if (Array.isArray(data)) {
          allUsers = data;
        } else {
          allUsers = [];
        }
      } catch (err) {
        console.error(err);
      }
    }

    function getUserById(id) {
      return allUsers.find((u) => u.id === Number(id));
    }

    function renderConvoList() {
      convoListEl.innerHTML = "";
      if (!currentModelUser) return;

      const partners = {};
      for (const m of currentMessages) {
        const partnerId =
          m.fromUserId === currentModelUser.id ? m.toUserId : m.fromUserId;
        if (!partners[partnerId]) {
          partners[partnerId] = {
            partnerId,
            lastMessage: m,
          };
        } else {
          partners[partnerId].lastMessage = m;
        }
      }

      const partnerArray = Object.values(partners);

      if (partnerArray.length === 0) {
        const li = document.createElement("li");
        li.className = "small";
        li.textContent = "Noch keine Konversationen.";
        convoListEl.appendChild(li);
        return;
      }

      partnerArray.sort(
        (a, b) =>
          new Date(b.lastMessage.timestamp) - new Date(a.lastMessage.timestamp)
      );

      for (const p of partnerArray) {
        const user = getUserById(p.partnerId);
        const li = document.createElement("li");
        li.className = "convo-item";
        if (currentPartnerId === p.partnerId) {
          li.classList.add("active");
        }

        const name = user ? user.email : "User #" + p.partnerId;

        const divLeft = document.createElement("div");
        divLeft.innerHTML =
          "<strong>" +
          name +
          "</strong><br/><span class='small'>" +
          (p.lastMessage.text.length > 30
            ? p.lastMessage.text.slice(0, 30) + "..."
            : p.lastMessage.text) +
          "</span>";

        const divRight = document.createElement("div");
        divRight.className = "badge";
        const t = new Date(p.lastMessage.timestamp);
        divRight.textContent =
          t.getHours().toString().padStart(2, "0") +
          ":" +
          t.getMinutes().toString().padStart(2, "0");

        li.appendChild(divLeft);
        li.appendChild(divRight);

        li.addEventListener("click", () => {
          currentPartnerId = p.partnerId;
          renderConvoList();
          renderChatMessages();
        });

        convoListEl.appendChild(li);
      }
    }

    function renderChatMessages() {
      chatMessagesEl.innerHTML = "";

      if (!currentModelUser || !currentPartnerId) {
        chatPartnerLabel.textContent = "–";
        chatInfoLabel.textContent =
          "Bitte zuerst eine Konversation links auswählen.";
        return;
      }

      const partnerUser = getUserById(currentPartnerId);
      chatPartnerLabel.textContent = partnerUser
        ? partnerUser.email + " (ID: " + partnerUser.id + ")"
        : "User #" + currentPartnerId;

      chatInfoLabel.textContent = "Du chattest als Model. Deine Nachrichten sind kostenlos.";

      const convo = currentMessages.filter(
        (m) =>
          (m.fromUserId === currentModelUser.id &&
            m.toUserId === currentPartnerId) ||
          (m.toUserId === currentModelUser.id &&
            m.fromUserId === currentPartnerId)
      );

      for (const m of convo) {
        const div = document.createElement("div");
        div.className =
          "msg " +
          (m.fromUserId === currentModelUser.id ? "me" : "other");
        div.textContent = m.text;

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        const t = new Date(m.timestamp);
        meta.textContent =
          (m.fromUserId === currentModelUser.id ? "Du" : "Client") +
          " · " +
          t.toLocaleString();

        const wrapper = document.createElement("div");
        wrapper.appendChild(div);
        wrapper.appendChild(meta);

        chatMessagesEl.appendChild(wrapper);
      }

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function loadMessagesForModel() {
      if (!currentModelUser) return;
      try {
        const res = await fetch(
          API_BASE + "/api/messages/forUser/" + currentModelUser.id
        );
        const data = await res.json();
        if (Array.isArray(data)) {
          currentMessages = data;
        } else {
          currentMessages = [];
        }
        await loadAllUsers();
        renderConvoList();
        renderChatMessages();
        setChatStatus("Konversationen aktualisiert.", true);
      } catch (err) {
        console.error(err);
        setChatStatus("Fehler beim Laden der Konversationen.", false);
      }
    }

    async function handleLogin() {
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;

      if (!email || !password) {
        setLoginStatus("Bitte E-Mail und Passwort eingeben.", false);
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          setLoginStatus(data.error || "Login fehlgeschlagen.", false);
          return;
        }

        if (data.role !== "model") {
          setLoginStatus(
            "Dieser Account ist kein Model (role=" + data.role + ").",
            false
          );
          return;
        }

        currentModelUser = data;
        setLoginStatus("Login erfolgreich.", true);
        setHeaderLoggedIn(data);

        loginCard.style.display = "none";
        modelInfoCard.style.display = "block";
        convoListCard.style.display = "block";

        modelEmail.textContent = "E-Mail: " + data.email;
        modelId.textContent = "ID: " + data.id;
        modelRole.textContent = "Rolle: " + data.role;
        modelTokens.textContent = "Tokens (aktuell): " + data.tokens;

        chatInfoLabel.textContent =
          "Klicke links auf 'Konversationen laden', um deine Chats zu sehen.";
      } catch (err) {
        console.error(err);
        setLoginStatus("Fehler bei der Verbindung zum Backend.", false);
      }
    }

    async function sendReply() {
      if (!currentModelUser) {
        setChatStatus("Bitte zuerst als Model einloggen.", false);
        return;
      }
      if (!currentPartnerId) {
        setChatStatus("Bitte zuerst eine Konversation auswählen.", false);
        return;
      }
      const text = chatInput.value.trim();
      if (!text) {
        setChatStatus("Nachricht darf nicht leer sein.", false);
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/messages/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fromUserId: currentModelUser.id,
            toUserId: currentPartnerId,
            text,
            cost: 0,
          }),
        });
        const data = await res.json();
        if (!res.ok) {
          setChatStatus(data.error || "Fehler beim Senden.", false);
          return;
        }

        chatInput.value = "";
        setChatStatus("Nachricht gesendet.", true);

        await loadMessagesForModel();
      } catch (err) {
        console.error(err);
        setChatStatus("Fehler bei der Verbindung zum Backend.", false);
      }
    }

    btnLoginModel.addEventListener("click", () => {
      handleLogin();
    });

    loginPasswordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        handleLogin();
      }
    });

    btnLoadConvos.addEventListener("click", () => {
      loadMessagesForModel();
    });

    btnSendReply.addEventListener("click", () => {
      sendReply();
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendReply();
      }
    });

    setHeaderLoggedOut();
  </script>
</body>
</html>
