<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>AdultChat – Model Konsole</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #05050a;
        color: #f5f5f5;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
      }

      .wrapper {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      h2 {
        font-size: 18px;
        margin: 16px 0 8px;
      }

      .card {
        background: #11111a;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid #2a2a3a;
      }

      label {
        display: block;
        font-size: 14px;
        margin-bottom: 4px;
      }

      input,
      textarea {
        width: 100%;
        box-sizing: border-box;
        border-radius: 6px;
        border: 1px solid #33334a;
        padding: 8px 10px;
        background: #070712;
        color: #f5f5f5;
        font-size: 14px;
        margin-bottom: 10px;
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        background: #b72a4d;
        color: #fff;
        margin-right: 8px;
        margin-top: 4px;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        font-size: 13px;
        color: #aaaaee;
        margin-top: 4px;
      }

      .danger {
        color: #ff6b81;
      }

      .messages {
        max-height: 260px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #2b2b3b;
        padding: 8px;
        background: #050509;
        font-size: 13px;
      }

      .msg {
        padding: 6px 8px;
        border-radius: 6px;
        margin-bottom: 6px;
      }

      .msg.model {
        background: #291223;
        text-align: right;
      }

      .msg.client {
        background: #122129;
        text-align: left;
      }

      .msg-meta {
        font-size: 11px;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h1>AdultChat – Model Konsole</h1>
      <p style="font-size: 14px; opacity: 0.8">
        Hier loggst du dich als <strong>Model</strong> ein und beantwortest
        Chats. Diese Seite spricht direkt mit dem Backend auf Render.
      </p>

      <!-- LOGIN CARD -->
      <div class="card" id="login-card">
        <h2>Login als Model</h2>
        <label for="login-email">E-Mail</label>
        <input id="login-email" type="email" placeholder="model@example.com" />

        <label for="login-password">Passwort</label>
        <input
          id="login-password"
          type="password"
          placeholder="Dein Passwort"
        />

        <button id="btn-login-model">Einloggen</button>
        <div class="status" id="login-status">Noch nicht eingeloggt.</div>
      </div>

      <!-- MAIN CARD (NUR WENN EINGELOGGT) -->
      <div class="card" id="main-card" style="display: none">
        <h2>
          Aktive Model-Session:
          <span id="model-info" style="font-weight: normal"></span>
        </h2>

        <div class="status" id="token-info"></div>

        <hr style="border-color: #222; margin: 12px 0" />

        <h3>Konversation</h3>
        <label for="conv-id">Konversation-ID</label>
        <input
          id="conv-id"
          type="text"
          placeholder="z.B. 1 oder client-1-model-1"
        />

        <button id="btn-load-conversation">Konversation laden</button>
        <div class="status" id="conv-status"></div>

        <div class="messages" id="messages-box"></div>

        <h3>Antwort senden</h3>
        <textarea
          id="msg-text"
          placeholder="Antwort an den Kunden..."
        ></textarea>

        <button id="btn-send-msg">Nachricht senden</button>
        <div class="status" id="send-status"></div>
      </div>
    </div>

    <script>
      // *** WICHTIG: Backend-URL ***
      const API_BASE = "https://adultchat-backend.onrender.com";

      const loginEmailInput = document.getElementById("login-email");
      const loginPasswordInput = document.getElementById("login-password");
      const loginBtn = document.getElementById("btn-login-model");
      const loginStatus = document.getElementById("login-status");
      const loginCard = document.getElementById("login-card");
      const mainCard = document.getElementById("main-card");
      const modelInfo = document.getElementById("model-info");
      const tokenInfo = document.getElementById("token-info");

      const convIdInput = document.getElementById("conv-id");
      const convStatus = document.getElementById("conv-status");
      const messagesBox = document.getElementById("messages-box");
      const msgTextInput = document.getElementById("msg-text");
      const sendStatus = document.getElementById("send-status");
      const loadConvBtn = document.getElementById("btn-load-conversation");
      const sendMsgBtn = document.getElementById("btn-send-msg");

      let loggedInModel = null;

      function setLoginStatus(text, isError = false) {
        loginStatus.textContent = text;
        loginStatus.classList.toggle("danger", isError);
      }

      function setConvStatus(text, isError = false) {
        convStatus.textContent = text;
        convStatus.classList.toggle("danger", isError);
      }

      function setSendStatus(text, isError = false) {
        sendStatus.textContent = text;
        sendStatus.classList.toggle("danger", isError);
      }

      function renderMessages(msgs) {
        messagesBox.innerHTML = "";
        if (!msgs || msgs.length === 0) {
          messagesBox.innerHTML =
            '<div style="opacity:0.7">Keine Nachrichten in dieser Konversation.</div>';
          return;
        }

        msgs.forEach((m) => {
          const div = document.createElement("div");
          div.classList.add("msg");
          div.classList.add(m.senderRole === "model" ? "model" : "client");

          const who =
            m.senderRole === "model" ? "Du (Model)" : "Kunde (Client)";
          const date = new Date(m.timestamp).toLocaleString();

          div.innerHTML = `
            <div>${m.text}</div>
            <div class="msg-meta">${who} · ${date}</div>
          `;
          messagesBox.appendChild(div);
        });

        messagesBox.scrollTop = messagesBox.scrollHeight;
      }

      // --- LOGIN ALS MODEL ---
      loginBtn.addEventListener("click", async () => {
        const email = loginEmailInput.value.trim();
        const password = loginPasswordInput.value.trim();

        if (!email || !password) {
          setLoginStatus("Bitte E-Mail und Passwort eingeben.", true);
          return;
        }

        loginBtn.disabled = true;
        setLoginStatus("Einloggen...", false);

        try {
          const res = await fetch(`${API_BASE}/api/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              password,
              role: "model", // GANZ WICHTIG: exakt so wie im Backend
            }),
          });

          const data = await res.json();

          if (!res.ok || !data.ok) {
            setLoginStatus(
              "Login fehlgeschlagen: " + (data.error || res.statusText),
              true
            );
            loginBtn.disabled = false;
            return;
          }

          loggedInModel = data.user;
          setLoginStatus("Erfolgreich eingeloggt.", false);

          modelInfo.textContent = `${loggedInModel.email} (ID: ${loggedInModel.id})`;
          tokenInfo.textContent = `Tokens: ${
            loggedInModel.tokens ?? "unbekannt"
          }`;

          // Login-Card ausblenden, Main-Card anzeigen
          loginCard.style.display = "none";
          mainCard.style.display = "block";
        } catch (err) {
          console.error(err);
          setLoginStatus("Fehler beim Login (Netzwerk?).", true);
        } finally {
          loginBtn.disabled = false;
        }
      });

      // --- KONVERSATION LADEN ---
      loadConvBtn.addEventListener("click", async () => {
        if (!loggedInModel) {
          setConvStatus("Bitte zuerst einloggen.", true);
          return;
        }

        const convId = convIdInput.value.trim();
        if (!convId) {
          setConvStatus("Bitte eine Konversation-ID eingeben.", true);
          return;
        }

        loadConvBtn.disabled = true;
        setConvStatus("Lade Nachrichten...", false);

        try {
          const res = await fetch(
            `${API_BASE}/api/messages?conversationId=${encodeURIComponent(
              convId
            )}`
          );
          const data = await res.json();

          if (!res.ok || !data.ok) {
            setConvStatus(
              "Fehler beim Laden: " + (data.error || res.statusText),
              true
            );
            return;
          }

          renderMessages(data.messages);
          setConvStatus("Nachrichten geladen.", false);
        } catch (err) {
          console.error(err);
          setConvStatus("Netzwerkfehler beim Laden.", true);
        } finally {
          loadConvBtn.disabled = false;
        }
      });

      // --- NACHRICHT SENDEN ALS MODEL ---
      sendMsgBtn.addEventListener("click", async () => {
        if (!loggedInModel) {
          setSendStatus("Bitte zuerst einloggen.", true);
          return;
        }

        const convId = convIdInput.value.trim();
        const text = msgTextInput.value.trim();

        if (!convId) {
          setSendStatus("Konversation-ID fehlt.", true);
          return;
        }
        if (!text) {
          setSendStatus("Text darf nicht leer sein.", true);
          return;
        }

        sendMsgBtn.disabled = true;
        setSendStatus("Sende Nachricht...", false);

        try {
          // Für das Demo schicken wir eine Nachricht an irgendeinen Client.
          // In echt würdest du hier die clientId kennen.
          const body = {
            conversationId: convId,
            fromUserId: loggedInModel.id,
            toUserId: 9999, // Dummy Client-ID, später ersetzen
            senderRole: "model",
            text,
          };

          const res = await fetch(`${API_BASE}/api/messages`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          if (!res.ok || !data.ok) {
            setSendStatus(
              "Fehler beim Senden: " + (data.error || res.statusText),
              true
            );
            return;
          }

          setSendStatus("Nachricht gesendet.", false);
          msgTextInput.value = "";

          // Neue Nachricht direkt unten anhängen
          const currentMsgs =
            messagesBox.children.length > 0 ? [] : []; // einfach neu laden:
          loadConvBtn.click();
        } catch (err) {
          console.error(err);
          setSendStatus("Netzwerkfehler beim Senden.", true);
        } finally {
          sendMsgBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
